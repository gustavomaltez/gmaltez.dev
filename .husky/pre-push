#!/bin/sh

# Get the remote and URL being pushed to
remote="$1"
url="$2"

# Read stdin to get the commits being pushed
while read local_ref local_sha remote_ref remote_sha
do
  # Skip if deleting a branch
  if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
    continue
  fi

  # Determine the range of commits to check
  if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
    # New branch - check all commits
    range="$local_sha"
  else
    # Existing branch - check new commits only
    range="$remote_sha..$local_sha"
  fi

  # Check for Co-authored-by trailer in commit messages (must be at start of line)
  co_authored_commits=$(git log --format="%H %s" "$range" 2>/dev/null | while read hash subject; do
    if git log -1 --format="%B" "$hash" | grep -qiE "^Co-authored-by:"; then
      echo "$hash"
    fi
  done)

  if [ -n "$co_authored_commits" ]; then
    echo "❌ Push rejected: Found commits with 'Co-authored-by' trailer"
    echo ""
    echo "The following commits contain Co-authored-by:"
    for hash in $co_authored_commits; do
      git log -1 --format="  • %h - %s" "$hash"
    done
    echo ""
    echo "Please amend or rebase to remove Co-authored-by before pushing."
    exit 1
  fi
done

exit 0
